<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Syst√®me de D√©claration d'Incident - Version Optimis√©e (connect√©e API)</title>
  <style>
    :root {
      --primary-color: #0047ab;
      --secondary-color: #e6f0ff;
      --alert-color: #ff6b6b;
      --success-color: #4caf50;
      --warning-color: #ffc107;
      --dashboard-bg: #f8f9fa;
      --error-color: #dc3545;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background-color: #f5f7fb; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
    .header { background: linear-gradient(135deg, var(--primary-color), #00337c); color: white; padding: 25px; text-align: center; position: relative; }
    .header h1 { font-size: 28px; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 16px; }
    .version-badge { position: absolute; top: 10px; right: 10px; background-color: var(--success-color); color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
    .nav-tabs { display: flex; margin-bottom: 0; border-bottom: 1px solid #dee2e6; background-color: #f8f9fa; }
    .nav-tab { padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: 500; }
    .nav-tab:hover { background-color: #e9ecef; }
    .nav-tab.active { border-bottom: 3px solid var(--primary-color); font-weight: bold; color: var(--primary-color); background-color: white; }
    .reference-bar { background-color: #e9ecef; padding: 12px 25px; display: flex; justify-content: space-between; font-weight: bold; color: #495057; border-bottom: 1px solid #dee2e6; flex-wrap: wrap; gap: 10px; }
    .confidential-banner { background-color: var(--warning-color); color: #533f03; padding: 12px 25px; font-weight: bold; text-align: center; border-bottom: 2px solid #e0a800; }
    .content { padding: 25px; }
    .section { margin-bottom: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #e9ecef; }
    .section-title { background-color: var(--secondary-color); padding: 15px 25px; font-weight: bold; font-size: 18px; color: var(--primary-color); border-left: 4px solid var(--primary-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
    .section-title:hover { background-color: #d1e0ff; }
    .section-content { padding: 25px; display: none; }
    .section-content.active { display: block; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
    input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="datetime-local"], input[type="date"], select, textarea {
      width: 100%; padding: 12px 15px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; transition: all 0.3s; font-family: inherit;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 71, 171, 0.2); outline: none; }
    input.error, textarea.error, select.error { border-color: var(--error-color); }
    .field-error { color: var(--error-color); font-size: 14px; margin-top: 5px; display: none; }
    .field-error.active { display: block; }
    .checkbox-group { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 15px; }
    .checkbox-group label { font-weight: normal; display: inline-flex; align-items: center; cursor: pointer; margin: 0; }
    .checkbox-group input { margin-right: 8px; width: auto; cursor: pointer; }
    textarea { min-height: 100px; resize: vertical; }
    .btn-group { display: flex; justify-content: space-between; margin-top: 30px; flex-wrap: wrap; gap: 15px; }
    .btn { padding: 14px 30px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; text-align: center; min-width: 150px; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background-color: var(--primary-color); color: white; flex: 1; }
    .btn-primary:hover:not(:disabled) { background-color: #00337c; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
    .btn-success { background-color: var(--success-color); color: white; flex: 1; }
    .btn-success:hover:not(:disabled) { background-color: #43a047; }
    .btn-warning { background-color: var(--warning-color); color: #533f03; }
    .btn-warning:hover:not(:disabled) { background-color: #e0a800; }
    .notification { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; animation: slideIn 0.5s; border-left: 4px solid; }
    .notification.success { background-color: #d4edda; color: #155724; border-color: #28a745; }
    .notification.error { background-color: #f8d7da; color: #721c24; border-color: #dc3545; }
    .notification.warning { background-color: #fff3cd; color: #856404; border-color: #ffc107; }
    .notification.info { background-color: #d1ecf1; color: #0c5460; border-color: #17a2b8; }
    .notification.active { display: block; }
    .history-section { margin-top: 40px; border-top: 2px solid #e9ecef; padding-top: 30px; }
    .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .history-table th, .history-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
    .history-table th { background-color: var(--secondary-color); color: var(--primary-color); font-weight: 600; }
    .history-table tr:hover { background-color: #f8f9fa; }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 500; display: inline-block; }
    .status-draft { background-color: #e9ecef; color: #495057; }
    .status-submitted { background-color: #d1ecf1; color: #0c5460; }
    .action-buttons { display: flex; gap: 8px; }
    .action-btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; color: white; }
    .action-btn.view { background-color: #007bff; }
    .action-btn.view:hover { background-color: #0056b3; }
    .action-btn.delete { background-color: #dc3545; }
    .action-btn.delete:hover { background-color: #c82333; }
    .required::after { content: " *"; color: var(--alert-color); }
    .dashboard-section { display: none; padding: 25px; background-color: var(--dashboard-bg); }
    .dashboard-section.active { display: block; }
    .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card h3 { color: var(--primary-color); margin-bottom: 10px; font-size: 16px; }
    .stat-card .value { font-size: 32px; font-weight: bold; color: var(--primary-color); }
    .chart-container { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px; }
    .chart-container h3 { margin-bottom: 15px; color: var(--primary-color); }
    .loading-spinner { display: none; text-align: center; padding: 20px; }
    .loading-spinner.active { display: block; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    .footer { text-align: center; padding: 25px; background-color: #f8f9fa; color: #6c757d; font-size: 14px; border-top: 1px solid #e9ecef; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) { .btn-group { flex-direction: column; } .btn { width: 100%; } .content { padding: 15px; } .section-content { padding: 15px; } .reference-bar { flex-direction: column; } .dashboard-stats { grid-template-columns: 1fr; } }
    .auto-save-indicator { position: fixed; bottom: 20px; right: 20px; background-color: var(--success-color); color: white; padding: 10px 20px; border-radius: 25px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: none; animation: slideIn 0.3s; }
    .auto-save-indicator.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="version-badge">id√©e et conception Mahdi Ben Jabeur</div>
      <h1>SYST√àME DE D√âCLARATION D'INCIDENT - RISQUE OP√âRATIONNEL</h1>
      <p>Soci√©t√© Tunisienne de Banque - Direction Risque Op√©rationnel & March√©</p>
    </div>

    <div class="nav-tabs">
      <div class="nav-tab active" data-tab="form">üìù Formulaire</div>
      <div class="nav-tab" data-tab="dashboard">üìä Tableau de bord</div>
      <div class="nav-tab" data-tab="audit">üîç Journal d'audit</div>
    </div>

    <div class="reference-bar">
      <div>R√©f√©rence: <span id="reference-number">RO-2026-00000</span></div>
      <div>Statut: <span id="form-status" class="status-badge status-draft">BROUILLON</span></div>
      <div>Date: <span id="current-date"></span></div>
    </div>

    <div class="confidential-banner">
      üîí CONFIDENTIEL - USAGE INTERNE UNIQUEMENT ‚Äì Ce document est prot√©g√© par le secret professionnel (Art. 15, loi n¬∞2003-75)
    </div>

    <!-- Section Formulaire -->
    <div id="form-section" class="content">
      <div id="notification-area"></div>
      <div class="loading-spinner"><div class="spinner"></div><p>Chargement en cours...</p></div>

      <div class="section">
        <div class="section-title" data-section="identification">
          1. IDENTIFICATION DE L'INCIDENT <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content active" id="identification-section">
          <div class="form-group">
            <label class="required">Date et heure de l'incident</label>
            <input type="datetime-local" id="incident-datetime" data-field="incidentDatetime" required>
            <div class="field-error" id="error-incident-datetime"></div>
          </div>
          <div class="form-group">
            <label class="required">Date et heure de d√©tection</label>
            <input type="datetime-local" id="detection-datetime" data-field="detectionDatetime" required>
            <div class="field-error" id="error-detection-datetime"></div>
          </div>
          <div class="form-group">
            <label class="required">Type d'incident</label>
            <div class="checkbox-group">
              <label><input type="checkbox" name="incident-type" value="fraude-interne"> Fraude interne</label>
              <label><input type="checkbox" name="incident-type" value="fraude-externe"> Fraude externe</label>
              <label><input type="checkbox" name="incident-type" value="defaillance-systeme"> D√©faillance syst√®me</label>
              <label><input type="checkbox" name="incident-type" value="erreur-operationnelle"> Erreur op√©rationnelle</label>
              <label><input type="checkbox" name="incident-type" value="risque-juridique"> Risque juridique</label>
              <label><input type="checkbox" name="incident-type" value="perte-donnees"> Perte de donn√©es</label>
            </div>
            <div class="field-error" id="error-incident-types"></div>
            <div style="margin-top: 10px;">
              <label>Autre type (pr√©ciser):</label>
              <input type="text" id="other-incident-type" data-field="otherIncidentType" placeholder="Sp√©cifier si autre type">
            </div>
          </div>
          <div class="form-group">
            <label class="required">Localisation</label>
            <input type="text" id="location" data-field="location" placeholder="Agence, Service, Syst√®me concern√©" required>
            <div class="field-error" id="error-location"></div>
          </div>
          <div class="form-group">
            <label class="required">D√©clarant</label>
            <input type="text" id="declarant-name" data-field="declarantName" placeholder="Nom complet" required>
            <div class="field-error" id="error-declarant-name"></div>
            <input type="text" id="declarant-position" data-field="declarantPosition" placeholder="Fonction/Poste" style="margin-top: 10px;" required>
            <div class="field-error" id="error-declarant-position"></div>
            <input type="text" id="declarant-contact" data-field="declarantContact" placeholder="Email ou T√©l√©phone" style="margin-top: 10px;" required>
            <div class="field-error" id="error-declarant-contact"></div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title" data-section="description">
          2. DESCRIPTION DE L'INCIDENT <span class="toggle-icon">‚ñ∂</span>
        </div>
        <div class="section-content" id="description-section">
          <div class="form-group">
            <label class="required">D√©tails chronologiques</label>
            <textarea id="incident-details" data-field="incidentDetails" placeholder="D√©crire l'encha√Ænement des √©v√©nements de mani√®re factuelle et pr√©cise" required></textarea>
            <div class="field-error" id="error-incident-details"></div>
          </div>
          <div class="form-group">
            <label>Personnes/entit√©s impliqu√©es</label>
            <textarea id="involved-parties" data-field="involvedParties" placeholder="Clients, collaborateurs, fournisseurs, etc."></textarea>
          </div>
          <div class="form-group">
            <label>Mesures imm√©diates prises</label>
            <textarea id="immediate-measures" data-field="immediateMeasures" placeholder="Ex. : Blocage de compte, arr√™t d'un syst√®me, alerte s√©curit√©"></textarea>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title" data-section="impact">
          3. √âVALUATION DE L'IMPACT <span class="toggle-icon">‚ñ∂</span>
        </div>
        <div class="section-content" id="impact-section">
          <div class="form-group">
            <label>Impact financier</label>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <input type="number" id="financial-impact" data-field="financialImpact" placeholder="Montant estim√© en DT" min="0" step="0.01">
                <div class="field-error" id="error-financial-impact"></div>
              </div>
              <div style="flex: 1; min-width: 200px;">
                <label style="display: block; margin-bottom: 5px;">Couverture assurance</label>
                <select id="insurance-coverage" data-field="insuranceCoverage">
                  <option value="">S√©lectionner</option>
                  <option value="yes">Oui</option>
                  <option value="no">Non</option>
                  <option value="unknown">Inconnu</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Impact op√©rationnel</label>
            <div class="checkbox-group">
              <label><input type="checkbox" name="operational-impact" value="interruption-partielle"> Interruption partielle</label>
              <label><input type="checkbox" name="operational-impact" value="blocage-total"> Blocage total</label>
              <label><input type="checkbox" name="operational-impact" value="perte-donnees"> Perte de donn√©es critiques</label>
            </div>
            <div style="margin-top: 10px;">
              <label>Dur√©e estim√©e de perturbation:</label>
              <input type="text" id="disruption-duration" data-field="disruptionDuration" placeholder="Ex. : 2 heures, 1 jour ouvrable">
            </div>
          </div>
          <div class="form-group">
            <label>Impact r√©putationnel</label>
            <div class="checkbox-group">
              <label><input type="checkbox" name="reputational-impact" value="risque-mediatique"> Risque m√©diatique</label>
              <label><input type="checkbox" name="reputational-impact" value="perte-confiance"> Perte de confiance clients</label>
              <label><input type="checkbox" name="reputational-impact" value="repercussions-reglementaires"> R√©percussions r√©glementaires</label>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title" data-section="analysis">
          4. ANALYSE ET PLAN D'ACTION <span class="toggle-icon">‚ñ∂</span>
        </div>
        <div class="section-content" id="analysis-section">
          <div class="form-group">
            <label>Cause racine identifi√©e</label>
            <textarea id="root-cause" data-field="rootCause" placeholder="Ex. : D√©faillance proc√©durale, erreur humaine, vuln√©rabilit√© technique"></textarea>
          </div>
          <div class="form-group">
            <label>Mesures correctives propos√©es</label>
            <textarea id="corrective-measures" data-field="correctiveMeasures" placeholder="Ex. : Renforcement des contr√¥les, formation compl√©mentaire, mise √† jour logicielle"></textarea>
          </div>
          <div class="form-group">
            <label>Responsable de suivi</label>
            <input type="text" id="followup-responsible" data-field="followupResponsible" placeholder="Nom du responsable">
            <input type="text" id="followup-position" data-field="followupPosition" placeholder="Fonction/Poste" style="margin-top: 10px;">
            <input type="date" id="followup-deadline" data-field="followupDeadline" style="margin-top: 10px;">
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title" data-section="approval">
          5. APPROBATION ET TRANSMISSION <span class="toggle-icon">‚ñ∂</span>
        </div>
        <div class="section-content" id="approval-section">
          <div class="form-group">
            <label>Validation par le Responsable Risque Op√©rationnel</label>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
              <div style="margin-bottom: 15px;">
                <label>Nom:</label>
                <input type="text" id="approver-name" data-field="approverName" placeholder="Nom complet du responsable">
              </div>
              <div>
                <label>Date d'approbation:</label>
                <input type="date" id="approval-date" data-field="approvalDate">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Transmission obligatoire</label>
            <div class="checkbox-group">
              <label><input type="checkbox" id="transmission-committee" data-field="transmissionCommittee"> Copie envoy√©e au Comit√© de Pilotage</label>
              <label><input type="checkbox" id="transmission-bct" data-field="transmissionBct"> D√©claration √† la BCT</label>
              <label><input type="checkbox" id="transmission-archive" data-field="transmissionArchive"> Archivage centralis√©</label>
            </div>
          </div>
        </div>
      </div>

      <!-- 6. PIECES JOINTES (nouveau) -->
      <div class="section">
        <div class="section-title" data-section="attachments">
          6. PI√àCES JOINTES <span class="toggle-icon">‚ñ∂</span>
        </div>
        <div class="section-content" id="attachments-section">
          <div class="form-group">
            <label>Ajouter des pi√®ces (PDF, images, etc.) ‚Äì max 10 Mo par fichier</label>
            <input type="file" id="attachments" multiple />
            <small style="color:#6c757d; display:block; margin-top:6px;">Ces fichiers seront envoy√©s au serveur via <code>multipart/form-data</code>.</small>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-warning" id="btn-save-draft">üíæ Enregistrer en brouillon</button>
        <button class="btn btn-secondary" id="btn-load-draft">üìÇ Charger le dernier brouillon</button>
        <button class="btn btn-success" id="btn-submit">‚úâÔ∏è Soumettre la d√©claration</button>
      </div>

      <div class="history-section">
        <h2 style="color: var(--primary-color); margin-bottom: 15px;">üìö Historique des d√©clarations</h2>
        <p style="margin-bottom: 15px; color: #6c757d;">Consultez et g√©rez vos d√©clarations pr√©c√©dentes</p>
        <div style="overflow-x: auto;">
          <table class="history-table">
            <thead>
              <tr>
                <th>R√©f√©rence</th>
                <th>Date d'incident</th>
                <th>Type</th>
                <th>Impact (DT)</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="history-table-body">
              <tr>
                <td colspan="6" style="text-align: center; padding: 20px; color: #6c757d;">Aucune d√©claration pour le moment</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Section Dashboard -->
    <div id="dashboard-section" class="dashboard-section">
      <h2 style="margin-bottom: 20px;">üìä Tableau de bord des incidents</h2>
      <div class="dashboard-stats">
        <div class="stat-card"><h3>Incidents totaux</h3><div id="total-incidents" class="value">0</div></div>
        <div class="stat-card"><h3>En brouillon</h3><div id="draft-incidents" class="value">0</div></div>
        <div class="stat-card"><h3>Soumis</h3><div id="submitted-incidents" class="value">0</div></div>
        <div class="stat-card"><h3>Impact total (DT)</h3><div id="total-financial-impact" class="value">0</div></div>
      </div>
      <div class="chart-container">
        <h3>üìà R√©partition par type d'incident</h3>
        <canvas id="type-chart" width="400" height="200"></canvas>
      </div>
      <div class="chart-container">
        <h3>üìÖ √âvolution mensuelle</h3>
        <canvas id="monthly-chart" width="400" height="200"></canvas>
      </div>
    </div>

    <!-- Section Audit -->
    <div id="audit-section" class="dashboard-section">
      <h2 style="margin-bottom: 20px;">üîç Journal d'audit</h2>
      <p style="margin-bottom: 20px; color: #6c757d;">Tra√ßabilit√© compl√®te de toutes les actions effectu√©es</p>
      <div style="overflow-x: auto;">
        <table class="history-table">
          <thead>
            <tr>
              <th>Horodatage</th>
              <th>Action</th>
              <th>Utilisateur</th>
              <th>R√©f√©rence</th>
              <th>D√©tails</th>
            </tr>
          </thead>
          <tbody id="audit-table-body">
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px; color: #6c757d;">Aucune entr√©e d'audit pour le moment</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      <p><strong>Syst√®me Int√©gr√© de Gestion de D√©claration D'un incident risque op√©rationnel (GDIRO)</strong></p>
      <p style="margin-top: 8px;">Conception et id√©e de MEHDI BEN JABEUR</p>
      <p style="margin-top: 8px;">Conforme aux exigences BCT - Circulaire n¬∞2006-19 ¬∑ B√¢le III ¬∑ RGPD</p>
      <p style="margin-top: 8px; font-size: 12px;">¬© 2026 Soci√©t√© Tunisienne de Banque - Tous droits r√©serv√©s</p>
    </div>
  </div>

  <div class="auto-save-indicator" id="auto-save-indicator">‚úì Sauvegarde automatique effectu√©e</div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
  'use strict';

  // ==================== CONFIGURATION (AJOUT API) ====================
  const CONFIG = {
    ENCRYPTION_KEY: 'STB-SIGR-2026-SECURE-KEY',
    AUTO_SAVE_INTERVAL: 30000, // 30s
    MAX_FINANCIAL_IMPACT: 10000000, // 10M DT
    VERSION: '2.1.0',
    // Si l'HTML est servi par le m√™me serveur Node (recommand√©), laissez vide pour utiliser des chemins relatifs
    API_BASE: '' // ex: '' ou 'http://localhost:3000'
  };

  // ==================== SECURE STORAGE CLASS ====================
  class SecureStorage {
    constructor(encryptionKey) { this.key = encryptionKey; }
    encrypt(data) { return CryptoJS.AES.encrypt(JSON.stringify(data), this.key).toString(); }
    decrypt(ciphertext) { const bytes = CryptoJS.AES.decrypt(ciphertext, this.key); return JSON.parse(bytes.toString(CryptoJS.enc.Utf8)); }
    setItem(key, value) { localStorage.setItem(key, this.encrypt(value)); return true; }
    getItem(key) { const encrypted = localStorage.getItem(key); return encrypted ? this.decrypt(encrypted) : null; }
    removeItem(key) { localStorage.removeItem(key); return true; }
    getAllKeys(prefix = '') { const keys = []; for (let i = 0; i < localStorage.length; i++) { const k = localStorage.key(i); if (k.startsWith(prefix)) keys.push(k); } return keys; }
  }

  // ==================== ERROR HANDLER ====================
  class ErrorHandler {
    static handle(error, context = '') {
      console.error(`[${context}]`, error);
      AuditLogger.log('ERROR', { context, message: error?.message, stack: error?.stack });
      NotificationManager.show(this.getUserFriendlyMessage(error), 'error');
    }
    static getUserFriendlyMessage(error) {
      const messages = {
        'NetworkError': 'Probl√®me de connexion r√©seau',
        'ValidationError': 'Donn√©es invalides, veuillez v√©rifier les champs',
        'StorageError': 'Erreur de sauvegarde des donn√©es',
        'EncryptionError': 'Erreur de s√©curit√© lors du traitement des donn√©es'
      };
      return messages[error?.name] || 'Une erreur technique est survenue. Veuillez r√©essayer.';
    }
  }

  // ==================== AUDIT LOGGER ====================
  class AuditLogger {
    static log(action, data = {}, userId = 'anonymous') {
      try {
        const auditEntry = {
          id: this.generateId(),
          timestamp: new Date().toISOString(),
          userId, action, data: this.sanitizeData(data),
          userAgent: navigator.userAgent, version: CONFIG.VERSION
        };
        const auditLog = secureStorage.getItem('auditLog') || [];
        auditLog.push(auditEntry); if (auditLog.length > 1000) auditLog.shift();
        secureStorage.setItem('auditLog', auditLog);
        if (document.getElementById('audit-section').classList.contains('active')) this.updateAuditUI();
        return auditEntry;
      } catch (e) { console.error('Audit logging failed', e); }
    }
    static generateId() { return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; }
    static sanitizeData(data) { const s = { ...data }; ['declarantContact','password','token'].forEach(f => delete s[f]); return s; }
    static updateAuditUI() {
      const tbody = document.getElementById('audit-table-body');
      const auditLog = secureStorage.getItem('auditLog') || [];
      if (auditLog.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#6c757d;">Aucune entr√©e d'audit pour le moment</td></tr>`;
        return;
      }
      const recentEntries = auditLog.slice(-50).reverse();
      tbody.innerHTML = recentEntries.map(e => `
        <tr>
          <td>${this.formatDateTime(e.timestamp)}</td>
          <td><strong>${e.action}</strong></td>
          <td>${e.userId}</td>
          <td>${e.data.reference || '-'}</td>
          <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${this.escapeHtml(JSON.stringify(e.data))}</td>
        </tr>`).join('');
    }
    static escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    static formatDateTime(iso) { return new Date(iso).toLocaleString('fr-FR', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' }); }
  }

  // ==================== NOTIFICATION MANAGER ====================
  class NotificationManager {
    static show(message, type = 'info', duration = 5000) {
      const area = document.getElementById('notification-area');
      const el = document.createElement('div');
      el.className = `notification ${type} active`;
      el.innerHTML = this.escapeHtml(message);
      area.innerHTML = ''; area.appendChild(el);
      if (duration > 0) setTimeout(() => { el.classList.remove('active'); setTimeout(() => el.remove(), 300); }, duration);
    }
    static escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    static showAutoSave() { const i = document.getElementById('auto-save-indicator'); i.classList.add('active'); setTimeout(() => i.classList.remove('active'), 2000); }
  }

  // ==================== VALIDATION SCHEMA ====================
  class ValidationSchema {
    static rules = {
      incidentDatetime: { required: true, type: 'datetime', validate: v => new Date(v) <= new Date(), message: "La date d'incident doit √™tre dans le pass√©" },
      detectionDatetime: { required: true, type: 'datetime', validate: (v, all) => (!all.incidentDatetime) || (new Date(v) >= new Date(all.incidentDatetime)), message: "La date de d√©tection doit √™tre post√©rieure √† l'incident" },
      location: { required: true, type: 'string', minLength: 5, message: 'La localisation doit contenir au moins 5 caract√®res' },
      declarantName: { required: true, type: 'string', minLength: 3, message: 'Le nom doit contenir au moins 3 caract√®res' },
      declarantPosition: { required: true, type: 'string', minLength: 3, message: 'Le poste doit contenir au moins 3 caract√®res' },
      declarantContact: { required: true, type: 'string', pattern: /(^[^\s@]+@[^\s@]+\.[^\s@]+$)|(\+?[\d\s-]{10,})/, message: 'Email ou num√©ro de t√©l√©phone invalide' },
      incidentDetails: { required: true, type: 'string', minLength: 20, message: 'Les d√©tails doivent contenir au moins 20 caract√®res' },
      financialImpact: { required: false, type: 'number', min: 0, max: CONFIG.MAX_FINANCIAL_IMPACT, message: `Le montant doit √™tre entre 0 et ${CONFIG.MAX_FINANCIAL_IMPACT} DT` }
    };
    static validate(data) {
      const errors = {};
      Object.keys(this.rules).forEach(field => {
        const rule = this.rules[field]; const value = data[field];
        if (rule.required && (!value || value.toString().trim() === '')) { errors[field] = 'Ce champ est obligatoire'; return; }
        if (!value && !rule.required) return;
        if (rule.minLength && value.length < rule.minLength) { errors[field] = rule.message; return; }
        if (rule.pattern && !rule.pattern.test(value)) { errors[field] = rule.message; return; }
        if (rule.type === 'number') {
          const num = parseFloat(value);
          if (rule.min !== undefined && num < rule.min) { errors[field] = rule.message; return; }
          if (rule.max !== undefined && num > rule.max) { errors[field] = rule.message; return; }
        }
        if (rule.validate && !rule.validate(value, data)) { errors[field] = rule.message; }
      });
      if (!data.incidentTypes || data.incidentTypes.length === 0) { errors.incidentTypes = "S√©lectionnez au moins un type d'incident"; }
      return { isValid: Object.keys(errors).length === 0, errors };
    }
    static showErrors(errors) {
      document.querySelectorAll('.field-error').forEach(el => { el.classList.remove('active'); el.textContent = ''; });
      document.querySelectorAll('input, textarea, select').forEach(el => el.classList.remove('error'));
      Object.keys(errors).forEach(field => {
        const errorDiv = document.getElementById(`error-${field.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
        const inputElement = document.querySelector(`[data-field="${field}"]`) || document.getElementById(field.replace(/([A-Z])/g, '-$1').toLowerCase());
        if (errorDiv) { errorDiv.textContent = errors[field]; errorDiv.classList.add('active'); }
        if (inputElement) { inputElement.classList.add('error'); }
      });
    }
  }

  // ==================== INCIDENT MODEL ====================
  class IncidentModel {
    constructor() {
      this.data = { id: '', reference: '', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), status: 'draft', formData: {} };
    }
    generateReference() {
      const now = new Date();
      const year = now.getFullYear(); const month = String(now.getMonth()+1).padStart(2,'0'); const day = String(now.getDate()).padStart(2,'0');
      const hours = String(now.getHours()).padStart(2,'0'); const minutes = String(now.getMinutes()).padStart(2,'0');
      const random = Math.floor(1000 + Math.random()*9000);
      this.data.reference = `RO-${year}-${month}${day}${hours}${minutes}-${random}`;
      this.data.id = `incident-${Date.now()}`;
      return this.data.reference;
    }
    setField(field, value) { this.data.formData[field] = value; this.data.updatedAt = new Date().toISOString(); }
    collectFormData() {
      const formData = {};
      document.querySelectorAll('[data-field]').forEach(el => { const f = el.dataset.field; formData[f] = (el.type === 'checkbox') ? el.checked : el.value; });
      formData.incidentTypes = Array.from(document.querySelectorAll('input[name="incident-type"]:checked')).map(cb => cb.value);
      formData.operationalImpacts = Array.from(document.querySelectorAll('input[name="operational-impact"]:checked')).map(cb => cb.value);
      formData.reputationalImpacts = Array.from(document.querySelectorAll('input[name="reputational-impact"]:checked')).map(cb => cb.value);
      this.data.formData = formData; return formData;
    }
    validate() { this.collectFormData(); return ValidationSchema.validate(this.data.formData); }
    save(asDraft = true) {
      const validation = this.validate();
      if (!validation.isValid && !asDraft) { ValidationSchema.showErrors(validation.errors); throw new Error('Validation √©chou√©e'); }
      this.data.status = asDraft ? 'draft' : 'submitted'; this.data.updatedAt = new Date().toISOString(); if (!asDraft) this.data.submittedAt = new Date().toISOString();
      const storageKey = asDraft ? 'incidentDrafts' : 'submittedIncidents';
      const incidents = secureStorage.getItem(storageKey) || [];
      const idx = incidents.findIndex(i => i.id === this.data.id);
      if (idx !== -1) incidents[idx] = { ...this.data }; else incidents.push({ ...this.data });
      secureStorage.setItem(storageKey, incidents);
      AuditLogger.log(asDraft ? 'SAVE_DRAFT' : 'SUBMIT_INCIDENT', { reference: this.data.reference, id: this.data.id });
      return true;
    }
    load(incidentData) { this.data = { ...incidentData }; this.populateForm(); }
    populateForm() {
      const fd = this.data.formData || {};
      Object.keys(fd).forEach(field => { const el = document.querySelector(`[data-field="${field}"]`); if (el) { if (el.type === 'checkbox') el.checked = fd[field]; else el.value = fd[field] || ''; } });
      if (fd.incidentTypes) document.querySelectorAll('input[name="incident-type"]').forEach(cb => cb.checked = fd.incidentTypes.includes(cb.value));
      if (fd.operationalImpacts) document.querySelectorAll('input[name="operational-impact"]').forEach(cb => cb.checked = fd.operationalImpacts.includes(cb.value));
      if (fd.reputationalImpacts) document.querySelectorAll('input[name="reputational-impact"]').forEach(cb => cb.checked = fd.reputationalImpacts.includes(cb.value));
    }
    reset() {
      this.data = { id: '', reference: '', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), status: 'draft', formData: {} };
      this.generateReference();
      document.querySelectorAll('input, textarea, select').forEach(el => { if (el.type === 'checkbox') el.checked = false; else el.value = ''; });
      ValidationSchema.showErrors({});
    }
  }

  // ==================== API HELPERS (NOUVEAU) ====================
  async function apiPostIncident(incident, files = []) {
    const url = `${CONFIG.API_BASE}/api/incidents`;
    const formData = new FormData();
    // Joindre la charge utile JSON dans un champ "payload"
    formData.append('payload', new Blob([JSON.stringify(incident)], { type: 'application/json' }));
    // Ajouter les fichiers si pr√©sents
    for (const f of files) { formData.append('files', f, f.name); }
    const res = await fetch(url, { method: 'POST', body: formData, headers: { 'X-Request-ID': incident.reference } });
    if (!res.ok) throw new Error(`Erreur API (${res.status})`);
    return res.json().catch(() => ({}));
  }

  // ==================== UI CONTROLLER ====================
  class UIController {
    constructor(model) { this.model = model; this.autoSaveTimer = null; this.init(); }
    init() {
      this.setupEventListeners(); this.updateReferenceBar(); this.loadHistory(); this.initCharts(); this.startAutoSave();
      AuditLogger.log('SYSTEM_INIT', { version: CONFIG.VERSION });
    }
    setupEventListeners() {
      document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => this.switchTab(tab.dataset.tab)));
      document.querySelectorAll('.section-title').forEach(title => title.addEventListener('click', () => this.toggleSection(title.dataset.section)));
      document.querySelectorAll('[data-field]').forEach(el => {
        el.addEventListener('change', () => { const f = el.dataset.field; const v = (el.type === 'checkbox') ? el.checked : el.value; this.model.setField(f, v); });
        el.addEventListener('blur', () => this.validateField(el));
      });
      const loadBtn = document.getElementById('btn-load-draft'); if (loadBtn) loadBtn.addEventListener('click', () => this.loadDraft());
      document.getElementById('btn-save-draft').addEventListener('click', () => this.saveDraft());
      document.getElementById('btn-submit').addEventListener('click', () => this.submitIncident());
    }
    switchTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
      document.getElementById('form-section').style.display = tabName === 'form' ? 'block' : 'none';
      document.getElementById('dashboard-section').classList.toggle('active', tabName === 'dashboard');
      document.getElementById('audit-section').classList.toggle('active', tabName === 'audit');
      if (tabName === 'dashboard') this.updateDashboard(); else if (tabName === 'audit') AuditLogger.updateAuditUI();
      AuditLogger.log('TAB_SWITCH', { tab: tabName });
    }
    toggleSection(id) {
      const section = document.getElementById(`${id}-section`); const icon = document.querySelector(`.section-title[data-section="${id}"] .toggle-icon`);
      if (!section || !icon) return; if (section.classList.contains('active')) { section.classList.remove('active'); icon.textContent = '‚ñ∂'; } else { section.classList.add('active'); icon.textContent = '‚ñº'; }
    }
    validateField(el) {
      const field = el.dataset.field; if (!field) return; const rule = ValidationSchema.rules[field]; if (!rule) return; let error = null;
      if (rule.required && !el.value.trim()) error = 'Ce champ est obligatoire';
      else if (rule.pattern && el.value && !rule.pattern.test(el.value)) error = rule.message;
      else if (rule.minLength && el.value.length < rule.minLength) error = rule.message;
      const errorDiv = document.getElementById(`error-${field.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
      if (errorDiv) { if (error) { errorDiv.textContent = error; errorDiv.classList.add('active'); el.classList.add('error'); } else { errorDiv.classList.remove('active'); el.classList.remove('error'); } }
    }
    updateReferenceBar() {
      const ref = document.getElementById('reference-number'); if (ref) ref.textContent = this.model.data.reference;
      const dateEl = document.getElementById('current-date'); if (dateEl) dateEl.textContent = new Date().toLocaleDateString('fr-FR');
      const statusBadge = document.getElementById('form-status');
      statusBadge.className = `status-badge status-${this.model.data.status}`;
      statusBadge.textContent = this.model.data.status === 'draft' ? 'BROUILLON' : 'SOUMISE';
    }
    loadDraft() {
      try { const drafts = secureStorage.getItem('incidentDrafts') || []; if (drafts.length === 0) { NotificationManager.show('Aucun brouillon disponible', 'warning'); return; }
        const latest = drafts[drafts.length - 1]; this.model.load(latest); this.updateReferenceBar();
        NotificationManager.show(`Brouillon charg√©: ${latest.reference}`, 'success'); AuditLogger.log('LOAD_DRAFT', { reference: latest.reference });
      } catch (e) { ErrorHandler.handle(e, 'UIController.loadDraft'); }
    }
    saveDraft() {
      try {
        if (this.model.save(true)) { NotificationManager.show('Brouillon enregistr√© avec succ√®s', 'success'); this.loadHistory(); } else { NotificationManager.show("Erreur lors de l'enregistrement", 'error'); }
      } catch (e) { ErrorHandler.handle(e, 'UIController.saveDraft'); }
    }
    async submitIncident() {
      try {
        const validation = this.model.validate();
        if (!validation.isValid) {
          ValidationSchema.showErrors(validation.errors);
          NotificationManager.show('Veuillez corriger les erreurs avant de soumettre', 'error');
          const firstField = Object.keys(validation.errors)[0];
          const el = document.querySelector(`[data-field="${firstField}"]`) || document.getElementById(firstField.replace(/([A-Z])/g, '-$1').toLowerCase());
          if (el) {
            const section = el.closest('.section-content'); if (section && !section.classList.contains('active')) { const id = section.id.replace('-section',''); this.toggleSection(id); }
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return;
        }
        // Pr√©paration des fichiers
        const filesInput = document.getElementById('attachments');
        const files = filesInput && filesInput.files ? Array.from(filesInput.files) : [];
        // 1) Sauvegarde locale (pour continuit√© UX)
        this.model.save(false);
        // 2) Envoi serveur
        const serverResp = await apiPostIncident(this.model.data, files);
        // 3) Nettoyage des brouillons locaux concernant cet id
        const drafts = (secureStorage.getItem('incidentDrafts') || []).filter(d => d.id !== this.model.data.id);
        secureStorage.setItem('incidentDrafts', drafts);
        NotificationManager.show(`D√©claration ${this.model.data.reference} soumise et envoy√©e au serveur !`, 'success', 7000);
        this.loadHistory(); this.model.reset(); this.updateReferenceBar(); window.scrollTo({ top: 0, behavior: 'smooth' });
        AuditLogger.log('API_SUBMIT_OK', { reference: this.model.data.reference, server: serverResp });
      } catch (e) {
        AuditLogger.log('API_SUBMIT_KO', { reference: this.model.data.reference, message: e.message });
        NotificationManager.show("Envoi au serveur indisponible. La d√©claration est conserv√©e localement et sera r√©-essay√©e.", 'warning', 8000);
        ErrorHandler.handle(e, 'UIController.submitIncident');
      }
    }
    loadHistory() {
      const tbody = document.getElementById('history-table-body');
      const submitted = secureStorage.getItem('submittedIncidents') || [];
      const drafts = secureStorage.getItem('incidentDrafts') || [];
      const all = [...submitted, ...drafts].sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      if (all.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#6c757d;">Aucune d√©claration pour le moment</td></tr>`; return;
      }
      tbody.innerHTML = all.slice(0, 10).map(inc => {
        const incidentDate = inc.formData.incidentDatetime ? new Date(inc.formData.incidentDatetime).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
        const types = inc.formData.incidentTypes ? inc.formData.incidentTypes.slice(0,2).join(', ') : 'Non sp√©cifi√©';
        const impact = (inc.formData.financialImpact ?? '-')
        return `
          <tr>
            <td><strong>${inc.reference}</strong></td>
            <td>${incidentDate}</td>
            <td>${types}</td>
            <td>${impact !== '-' ? impact + ' DT' : '-'}</td>
            <td><span class="status-badge status-${inc.status}">${inc.status === 'draft' ? 'Brouillon' : 'Soumise'}</span></td>
            <td class="action-buttons">
              <button class="action-btn view" onclick="uiController.viewIncident('${inc.id}')">üëÅÔ∏è Voir</button>
              ${inc.status === 'draft' ? `<button class="action-btn delete" onclick="uiController.deleteIncident('${inc.id}')">üóëÔ∏è Suppr.</button>` : ''}
            </td>
          </tr>`;
      }).join('');
    }
    viewIncident(id) {
      try {
        const submitted = secureStorage.getItem('submittedIncidents') || [];
        const drafts = secureStorage.getItem('incidentDrafts') || [];
        const all = [...submitted, ...drafts];
        const incident = all.find(i => i.id === id);
        if (incident) {
          this.model.load(incident); this.updateReferenceBar();
          document.querySelectorAll('.section-content').forEach(s => s.classList.add('active'));
          document.querySelectorAll('.toggle-icon').forEach(i => i.textContent = '‚ñº');
          window.scrollTo({ top: 0, behavior: 'smooth' });
          NotificationManager.show('D√©claration charg√©e en mode consultation', 'info');
          AuditLogger.log('VIEW_INCIDENT', { reference: incident.reference });
        }
      } catch (e) { ErrorHandler.handle(e, 'UIController.viewIncident'); }
    }
    deleteIncident(id) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce brouillon ?')) return;
      try {
        const drafts = secureStorage.getItem('incidentDrafts') || [];
        const inc = drafts.find(d => d.id === id);
        const updated = drafts.filter(d => d.id !== id);
        secureStorage.setItem('incidentDrafts', updated);
        this.loadHistory(); NotificationManager.show('Brouillon supprim√©', 'success');
        if (inc) AuditLogger.log('DELETE_DRAFT', { reference: inc.reference });
      } catch (e) { ErrorHandler.handle(e, 'UIController.deleteIncident'); }
    }
    startAutoSave() {
      this.autoSaveTimer = setInterval(() => {
        if (this.model.data.status === 'draft' && Object.keys(this.model.data.formData).length > 0) {
          this.model.collectFormData();
          const hasData = this.model.data.formData.incidentDatetime || this.model.data.formData.location || this.model.data.formData.declarantName;
          if (hasData) { this.model.save(true); NotificationManager.showAutoSave(); AuditLogger.log('AUTO_SAVE', { reference: this.model.data.reference }); }
        }
      }, CONFIG.AUTO_SAVE_INTERVAL);
    }
    initCharts() {
      const typeCtx = document.getElementById('type-chart').getContext('2d');
      this.typeChart = new Chart(typeCtx, { type: 'bar', data: { labels: ['Fraude interne','Fraude externe','D√©faillance syst√®me','Erreur op√©rationnelle','Risque juridique','Perte de donn√©es'], datasets: [{ label: "Nombre d'incidents", data: [0,0,0,0,0,0], backgroundColor: '#0047ab' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
      const monthlyCtx = document.getElementById('monthly-chart').getContext('2d');
      this.monthlyChart = new Chart(monthlyCtx, { type: 'line', data: { labels: ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'], datasets: [{ label: 'Incidents mensuels', data: Array(12).fill(0), borderColor: '#0047ab', backgroundColor: 'rgba(0,71,171,0.1)', tension: 0.3, fill: true }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
    }
    updateDashboard() {
      const submitted = secureStorage.getItem('submittedIncidents') || [];
      const drafts = secureStorage.getItem('incidentDrafts') || [];
      document.getElementById('total-incidents').textContent = submitted.length + drafts.length;
      document.getElementById('draft-incidents').textContent = drafts.length;
      document.getElementById('submitted-incidents').textContent = submitted.length;
      const totalImpact = submitted.reduce((s, i) => s + (parseFloat(i.formData.financialImpact) || 0), 0);
      document.getElementById('total-financial-impact').textContent = totalImpact.toLocaleString('fr-FR', { maximumFractionDigits: 0 });
      const typeCounts = { 'fraude-interne':0,'fraude-externe':0,'defaillance-systeme':0,'erreur-operationnelle':0,'risque-juridique':0,'perte-donnees':0 };
      submitted.forEach(inc => { if (inc.formData.incidentTypes) inc.formData.incidentTypes.forEach(t => { if (typeCounts.hasOwnProperty(t)) typeCounts[t]++; }); });
      this.typeChart.data.datasets[0].data = Object.values(typeCounts); this.typeChart.update();
      const monthlyCounts = Array(12).fill(0); submitted.forEach(inc => { const m = inc.submittedAt ? new Date(inc.submittedAt).getMonth() : new Date(inc.updatedAt).getMonth(); monthlyCounts[m]++; });
      this.monthlyChart.data.datasets[0].data = monthlyCounts; this.monthlyChart.update();
    }
  }

  // ==================== INITIALISATION ====================
  let secureStorage; let incidentModel; let uiController;
  document.addEventListener('DOMContentLoaded', function () {
    try {
      secureStorage = new SecureStorage(CONFIG.ENCRYPTION_KEY);
      incidentModel = new IncidentModel(); incidentModel.generateReference();
      uiController = new UIController(incidentModel);
      console.log('%c‚úì Syst√®me initialis√© avec succ√®s (connect√© API)', 'color: green; font-weight: bold;');
      console.log(`Version: ${CONFIG.VERSION}`);
      console.log('Chiffrement: AES-256');
      console.log('Audit trail: Activ√©');
    } catch (e) {
      console.error("Erreur d'initialisation:", e);
      NotificationManager.show("Erreur d'initialisation du syst√®me. Veuillez actualiser la page.", 'error', 0);
    }
  });
  window.addEventListener('beforeunload', function () { if (uiController?.autoSaveTimer) clearInterval(uiController.autoSaveTimer); });
  </script>
</body>
</html>
